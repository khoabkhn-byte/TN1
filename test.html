<!doctype html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Làm bài thi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .quiz-container { max-width: 1000px; margin: 30px auto; }
        .question-card { margin-bottom: 20px; border-left: 5px solid #0d6efd; }
        .question-card.answered { border-left: 5px solid #198754; } /* Màu xanh khi đã trả lời */
        .question-navigation button { margin: 2px; }
        .sidebar { position: sticky; top: 20px; }
    </style>
</head>
<body>
    <div class="container quiz-container">
        
        <div class="row mb-4 p-3 bg-light rounded shadow-sm sticky-top">
            <div class="col-md-4">
                <h4 id="test-name">Đang tải tên bài thi...</h4>
            </div>
            <div class="col-md-4 text-center">
                Thời gian còn lại: <strong id="countdown-timer" class="text-danger fs-5">--:--</strong>
            </div>
            <div class="col-md-4 text-end">
                <button class="btn btn-danger" id="submit-quiz-btn" onclick="submitTest()">Nộp Bài</button>
            </div>
        </div>

        <div class="row">
            <div class="col-md-9">
                <div id="quiz-content">
                    <div class="text-center p-5" id="loading-spinner">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2">Đang tải đề thi...</p>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="sidebar p-3 border rounded">
                    <h5>Điều hướng Câu hỏi</h5>
                    <div id="question-navigation" class="question-navigation">
                        </div>
                </div>
            </div>
        </div>

        <div class="row mt-5" id="result-view" style="display:none;">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Kết quả bài làm</h5>
                    </div>
                    <div class="card-body" id="result-details">
                        </div>
                </div>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Biến trạng thái toàn cục
let testData = null;       // Dữ liệu đề thi
let studentAnswers = {};   // Lưu trữ câu trả lời của học sinh: { 'questionId': 'answerValue' }
let timerInterval;         // Biến lưu trữ Interval của đồng hồ đếm ngược
const serverUrl = 'https://quiz-to21.onrender.com'; // Đảm bảo URL này đúng

// Hàm tiện ích: Lấy dữ liệu JSON từ API (giống hàm fetchJson bạn đã dùng)
async function fetchJson(url, opts) { /* ... */ } 

// Hàm tiện ích: Lấy tham số testId từ URL
const urlParams = new URLSearchParams(window.location.search);
const testId = urlParams.get('testId');
if (!testId) {
    document.getElementById('quiz-content').innerHTML = `<p class="alert alert-warning">Lỗi: Không tìm thấy ID bài thi.</p>`;
}

// ----------------------------------------------------
// A. HÀM TẢI ĐỀ THI
// ----------------------------------------------------

async function loadTest() {
    if (!testId) return;
    try {
        // Tải đề thi chi tiết từ API /api/tests/<testId>
        const data = await fetchJson(`${serverUrl}/api/tests/${testId}`); 
        testData = data;

        if (!testData || !testData.questions) {
            document.getElementById('quiz-content').innerHTML = `<p class="alert alert-danger">Không tìm thấy dữ liệu đề thi.</p>`;
            return;
        }

        document.getElementById('test-name').textContent = testData.name;
        document.getElementById('loading-spinner').style.display = 'none';

        // Khởi tạo các phần tử giao diện
        renderQuizContent();
        startTimer(testData.time); // Giả định trường thời gian là 'time'

    } catch(e) {
        document.getElementById('quiz-content').innerHTML = `<p class="alert alert-danger">Lỗi khi tải đề thi: ${e.message}</p>`;
        console.error("Lỗi tải đề thi:", e);
    }
}

// ----------------------------------------------------
// B. HÀM HIỂN THỊ GIAO DIỆN CÂU HỎI
// ----------------------------------------------------

function renderQuizContent() {
    const quizContent = document.getElementById('quiz-content');
    const navContainer = document.getElementById('question-navigation');
    quizContent.innerHTML = '';
    navContainer.innerHTML = '';
    
    testData.questions.forEach((q, index) => {
        const qIndex = index + 1;
        const isEssay = q.type === 'essay'; // Giả định trường type là 'essay'

        // 1. Render Card Câu hỏi
        const card = document.createElement('div');
        card.className = 'card question-card';
        card.id = `q-${q.id}`;
        card.innerHTML = `
            <div class="card-header bg-primary text-white">Câu ${qIndex}: (${isEssay ? 'Tự luận' : 'Trắc nghiệm'})</div>
            <div class="card-body">
                <p>${q.content}</p>
                ${isEssay 
                    ? `<textarea class="form-control essay-answer" rows="10" id="ans-${q.id}" data-qid="${q.id}" oninput="saveAnswer('${q.id}', this.value)"></textarea>`
                    : renderMultipleChoiceOptions(q, q.id)
                }
            </div>
        `;
        quizContent.appendChild(card);
        
        // 2. Render Nút điều hướng
        const navButton = document.createElement('button');
        navButton.className = 'btn btn-outline-primary btn-sm';
        navButton.textContent = qIndex;
        navButton.onclick = () => scrollToQuestion(q.id);
        navContainer.appendChild(navButton);
    });
}

function renderMultipleChoiceOptions(q, qid) {
    // Hàm này cần được viết để tạo các nút radio/checkbox
    // Dựa trên cấu trúc options của câu hỏi trắc nghiệm
    let html = '<div class="options-group">';
    // Giả định q.options là mảng các lựa chọn
    q.options.forEach((option, idx) => {
        const optionId = `${qid}-${idx}`;
        html += `
            <div class="form-check">
                <input class="form-check-input" type="radio" name="q-${qid}" id="${optionId}" 
                       value="${option.value}" onclick="saveAnswer('${qid}', this.value); updateNavButton('${qid}', true)">
                <label class="form-check-label" for="${optionId}">${option.text}</label>
            </div>
        `;
    });
    html += '</div>';
    return html;
}

// ----------------------------------------------------
// C. HÀM XỬ LÝ TRẠNG THÁI VÀ NỘP BÀI
// ----------------------------------------------------

function scrollToQuestion(qid) {
    document.getElementById(`q-${qid}`).scrollIntoView({ behavior: 'smooth' });
}

function saveAnswer(qid, answer) {
    studentAnswers[qid] = answer;
    // Cập nhật trạng thái 'answered' cho card câu hỏi
    const card = document.getElementById(`q-${qid}`);
    if (answer && answer.trim() !== '') {
        card.classList.add('answered');
    } else {
        card.classList.remove('answered');
    }
}

function updateNavButton(qid, isAnswered) {
    // Tương tự, bạn cần cập nhật màu nút điều hướng ở đây
    // Dùng data-qid để tìm nút tương ứng và đổi màu
}


// Hàm Đếm ngược thời gian
function startTimer(minutes) {
    let seconds = minutes * 60;
    const timerElement = document.getElementById('countdown-timer');

    timerInterval = setInterval(() => {
        seconds--;
        if (seconds < 0) {
            clearInterval(timerInterval);
            timerElement.textContent = "Hết giờ!";
            submitTest(true); // Tự động nộp bài khi hết giờ
            return;
        }

        const min = Math.floor(seconds / 60);
        const sec = seconds % 60;
        timerElement.textContent = `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
    }, 1000);
}

// Hàm Nộp bài
async function submitTest(isTimeUp = false) {
    if (!confirm(isTimeUp ? "Hết giờ! Tự động nộp bài." : "Bạn có chắc chắn muốn nộp bài?")) return;

    clearInterval(timerInterval); // Dừng đồng hồ
    document.getElementById('submit-quiz-btn').disabled = true;

    const currentUserId = 'YOUR_STUDENT_ID'; // Cần lấy ID học sinh từ session/local storage
    
    const resultPayload = {
        studentId: currentUserId, 
        testId: testId,
        answers: studentAnswers,
        submittedAt: new Date().toISOString(),
        status: "submitted"
        // Bạn có thể thêm trường tính điểm (score) nếu muốn tính ở frontend
    };

    try {
        // Gửi kết quả lên API /api/results (POST)
        const result = await fetchJson(`${serverUrl}/api/results`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(resultPayload)
        });

        alert("Nộp bài thành công!");
        showResult(result.id); // Chuyển sang chế độ xem kết quả
    } catch(e) {
        alert("Lỗi khi nộp bài. Vui lòng thử lại.");
        document.getElementById('submit-quiz-btn').disabled = false;
    }
}

// ----------------------------------------------------
// D. HÀM XEM KẾT QUẢ
// ----------------------------------------------------

async function showResult(resultId) {
    // Ẩn giao diện làm bài
    document.getElementById('quiz-content').style.display = 'none';
    document.querySelector('.sidebar').style.display = 'none';
    document.getElementById('submit-quiz-btn').style.display = 'none';

    // Hiển thị khu vực kết quả
    document.getElementById('result-view').style.display = 'block';

    try {
        // Tải kết quả chi tiết từ API /api/results/<resultId>
        const resultData = await fetchJson(`${serverUrl}/api/results/${resultId}`);

        // Ở đây, bạn sẽ cần một API khác để *chấm điểm* và *trả về chi tiết*
        // Giả sử API trả về score và details
        const detailsEl = document.getElementById('result-details');
        detailsEl.innerHTML = `
            <p class="fs-4 text-success">Điểm số: <strong>${resultData.score || 'Đang chờ chấm'}</strong></p>
            <p>Trạng thái: Đã nộp lúc ${new Date(resultData.submittedAt).toLocaleString()}</p>
            <button class="btn btn-info mt-3" onclick="viewDetailedAnswers()">Xem chi tiết bài làm</button>
        `;

        // **Lưu ý:** Chức năng "Xem lại kết quả sau khi đã bấm nộp bài" đòi hỏi API Backend phải có khả năng:
        // 1. Chấm điểm bài trắc nghiệm (Tự động)
        // 2. Lưu trữ và trả về đáp án đúng của đề thi.
        // 3. Trả về bài làm của học sinh cùng với kết quả chấm điểm.

    } catch(e) {
        document.getElementById('result-details').innerHTML = `<p class="alert alert-danger">Lỗi khi tải kết quả.</p>`;
    }
}

// Bắt đầu tải đề thi khi trang load
window.onload = loadTest;
    </script>
</body>
</html>
