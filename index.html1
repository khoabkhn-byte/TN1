<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá th·ªëng Qu·∫£n l√Ω B√†i ki·ªÉm tra</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f4f4; }
        #app-container { max-width: 1200px; margin: 20px auto; background-color: #fff; padding: 20px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); }
        h1 { text-align: center; color: #333; }
        #nav-bar { display: flex; justify-content: space-around; background-color: #007bff; padding: 10px 0; margin-bottom: 20px; }
        .tab-button { background: none; border: none; color: white; padding: 10px 20px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; }
        .tab-button:hover, .tab-button.active { background-color: #0056b3; }
        .tab-content { display: none; padding: 20px; border: 1px solid #ccc; border-top: none; }
        .tab-content.active { display: block; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .btn { background-color: #28a745; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px; }
        .btn:hover { background-color: #1e7e34; }
        .btn-primary { background-color: #007bff; }
        .btn-primary:hover { background-color: #0056b3; }
        .btn-info { background-color: #17a2b8; }
        .btn-info:hover { background-color: #0f6674; }
        .btn-edit { background-color: #ffc107; color: #333; }
        .btn-edit:hover { background-color: #e0a800; }
        .btn-delete { background-color: #dc3545; }
        .btn-delete:hover { background-color: #bd2130; }
        .logout { background-color: #6c757d; }
        .logout:hover { background-color: #5a6268; }
        
        /* Table Styles */
        #test-table th, #test-table td { padding: 8px; text-align: left; border: 1px solid #ddd; }
        #test-table th { background-color: #f2f2f2; }
        
        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 8px; position: relative;}
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close:hover, .close:focus { color: black; text-decoration: none; cursor: pointer; }

        /* Login/Register Form */
        #login-form, #register-form { max-width: 400px; margin: 50px auto; padding: 20px; border: 1px solid #ccc; border-radius: 8px; background-color: #fff; }

    </style>
</head>
<body>

<div id="auth-container">
    <div id="login-form">
        <h2>ƒêƒÉng nh·∫≠p</h2>
        <div class="form-group">
            <label for="login-username">T√™n ƒëƒÉng nh·∫≠p:</label>
            <input type="text" id="login-username" required>
        </div>
        <div class="form-group">
            <label for="login-password">M·∫≠t kh·∫©u:</label>
            <input type="password" id="login-password" required>
        </div>
        <button class="btn btn-primary" onclick="login()">ƒêƒÉng nh·∫≠p</button>
        <button class="btn logout" onclick="showRegisterForm()">ƒêƒÉng k√Ω</button>
        <p id="login-message" style="color: red; margin-top: 10px;"></p>
    </div>

    <div id="register-form" style="display: none;">
        <h2>ƒêƒÉng k√Ω</h2>
        <div class="form-group">
            <label for="register-username">T√™n ƒëƒÉng nh·∫≠p:</label>
            <input type="text" id="register-username" required>
        </div>
        <div class="form-group">
            <label for="register-password">M·∫≠t kh·∫©u:</label>
            <input type="password" id="register-password" required>
        </div>
        <div class="form-group">
            <label for="register-dob">Ng√†y sinh:</label>
            <input type="date" id="register-dob">
        </div>
        <div class="form-group">
            <label for="register-gender">Gi·ªõi t√≠nh:</label>
            <select id="register-gender">
                <option value="Nam">Nam</option>
                <option value="N·ªØ">N·ªØ</option>
                <option value="Kh√°c">Kh√°c</option>
            </select>
        </div>
        <button class="btn btn-primary" onclick="register()">ƒêƒÉng k√Ω</button>
        <button class="btn logout" onclick="showLoginForm()">H·ªßy</button>
        <p id="register-message" style="color: red; margin-top: 10px;"></p>
    </div>
</div>

<div id="app-content" style="display: none;">
    <h1 id="user-display"></h1>
    <div id="nav-bar">
        <button class="tab-button active" id="tab-test-button" onclick="showTab('tab-test')">B√†i ki·ªÉm tra</button>
        <button class="tab-button" id="tab-students-button" onclick="showTab('tab-students')">H·ªçc sinh</button>
        <button class="tab-button" id="tab-results-button" onclick="showTab('tab-results')">K·∫øt qu·∫£ b√†i l√†m</button>
        <button class="btn logout" onclick="logout()">ƒêƒÉng xu·∫•t</button>
    </div>

    <div id="tab-test" class="tab-content active">
        <h2>Qu·∫£n l√Ω B√†i ki·ªÉm tra</h2>
        <button class="btn" onclick="document.getElementById('create-test-modal').style.display='block'">+ T·∫°o B√†i ki·ªÉm tra m·ªõi</button>
        
        <div id="tests-list">
            <table id="test-table" border="1" style="width:100%; border-collapse: collapse; margin-top: 10px;">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>T√™n b√†i ki·ªÉm tra</th>
                        <th>M√¥n h·ªçc</th>
                        <th>Kh·ªëi</th>
                        <th>S·ªë c√¢u</th>
                        <th>Th·ªùi gian (ph√∫t)</th>
                        <th>Ng√†y t·∫°o</th>
                        <th>Ng√†y giao</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>H√†nh ƒë·ªông</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
    </div>
    
    <div id="create-test-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="document.getElementById('create-test-modal').style.display='none'">&times;</span>
            <h3>T·∫°o B√†i ki·ªÉm tra m·ªõi</h3>
            <div class="form-group">
                <label for="test-name">T√™n b√†i ki·ªÉm tra:</label>
                <input type="text" id="test-name" required>
            </div>
            <div class="form-group">
                <label for="test-subject">M√¥n h·ªçc:</label>
                <select id="test-subject">
                    <option value="toan">To√°n</option>
                    <option value="ly">L√Ω</option>
                    <option value="hoa">H√≥a</option>
                    <option value="anh">Anh</option>
                </select>
            </div>
            <div class="form-group">
                <label for="test-level">Kh·ªëi:</label>
                <input type="text" id="test-level">
            </div>
            <div class="form-group">
                <label for="test-time">Th·ªùi gian (ph√∫t):</label>
                <input type="number" id="test-time">
            </div>
            <button class="btn" onclick="addTest()">T·∫°o</button>
            <button class="btn logout" onclick="document.getElementById('create-test-modal').style.display='none'">H·ªßy</button>
        </div>
    </div>

    <div id="view-test-content-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="document.getElementById('view-test-content-modal').style.display='none'">&times;</span>
            <h3>N·ªôi dung B√†i ki·ªÉm tra: <span id="view-test-name"></span></h3>
            <p>Th·ªùi gian: <span id="view-test-time"></span> ph√∫t</p>
            <div id="view-test-questions">
                </div>
        </div>
    </div>
    
    <div id="edit-test-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="document.getElementById('edit-test-modal').style.display='none'">&times;</span>
            <h3>Ch·ªânh s·ª≠a B√†i ki·ªÉm tra</h3>
            <input type="hidden" id="edit-test-id">
            <div class="form-group">
                <label for="edit-test-name">T√™n b√†i ki·ªÉm tra:</label>
                <input type="text" id="edit-test-name" required>
            </div>
            <div class="form-group">
                <label for="edit-test-subject">M√¥n h·ªçc:</label>
                <select id="edit-test-subject">
                    <option value="toan">To√°n</option>
                    <option value="ly">L√Ω</option>
                    <option value="hoa">H√≥a</option>
                    <option value="anh">Anh</option>
                </select>
            </div>
            <div class="form-group">
                <label for="edit-test-level">Kh·ªëi:</label>
                <input type="text" id="edit-test-level">
            </div>
            <div class="form-group">
                <label for="edit-test-time">Th·ªùi gian (ph√∫t):</label>
                <input type="number" id="edit-test-time">
            </div>
            <button class="btn" onclick="updateTest()">L∆∞u</button>
            <button class="btn logout" onclick="document.getElementById('edit-test-modal').style.display='none'">H·ªßy</button>
        </div>
    </div>
    
    <div id="assign-test-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="document.getElementById('assign-test-modal').style.display='none'">&times;</span>
            <h3>Giao ƒë·ªÅ ki·ªÉm tra</h3>
            <input type="hidden" id="assign-modal-test-id">
            
            <p>B√†i ki·ªÉm tra ƒëang giao: <strong id="assign-modal-test-name"></strong></p>

            <div class="form-group">
                <label for="assign-modal-student">Ch·ªçn h·ªçc sinh:</label>
                <select id="assign-modal-student">
                    <option value="">-- Ch·ªçn h·ªçc sinh --</option>
                </select>
            </div>

            <div class="form-group">
                <label for="assign-modal-deadline">H·∫°n ch√≥t:</label>
                <input type="datetime-local" id="assign-modal-deadline" />
            </div>

            <button class="btn btn-primary" onclick="submitTestAssignment()">Giao ƒë·ªÅ</button>
            <button class="btn logout" onclick="document.getElementById('assign-test-modal').style.display='none'">H·ªßy</button>
        </div>
    </div>


    </div> <div id="tab-students" class="tab-content">
        <h2>Qu·∫£n l√Ω H·ªçc sinh</h2>
        <div id="students-list">
             </div>
    </div>

    <div id="tab-results" class="tab-content">
        <h2>K·∫øt qu·∫£ B√†i l√†m</h2>
        <div id="results-list">
             </div>
    </div>
</div>


<script>
    // üí° ƒê·∫¢M B·∫¢O CHU·ªñI K·∫æT N·ªêI MONGODB C·ª¶A B·∫†N L√Ä CH√çNH X√ÅC
    // Thay th·∫ø b·∫±ng URL th·ª±c t·∫ø n·∫øu b·∫°n ƒë√£ tri·ªÉn khai server (v√≠ d·ª•: http://localhost:3000/api)
   const serverUrl = window.location.origin;
    let currentUserId = null;
    let currentUserRole = null;
    
    const SUBJECT_NAMES = {
        'toan': 'To√°n',
        'ly': 'L√Ω',
        'hoa': 'H√≥a',
        'anh': 'Anh'
    };

    // --- HELPER FUNCTIONS ---

    function escapeHtml(unsafe) {
        if (!unsafe) return '';
        return unsafe.toString()
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    function formatDate(isoString) {
        if (!isoString) return 'Ch∆∞a c√≥';
        try {
            const date = new Date(isoString);
            if (isNaN(date.getTime())) return 'Ng√†y kh√¥ng h·ª£p l·ªá';
            return date.toLocaleDateString('vi-VN') + ' ' + date.toLocaleTimeString('vi-VN');
        } catch (e) {
            return 'Ng√†y kh√¥ng h·ª£p l·ªá';
        }
    }
    
    // --- NAVIGATION ---
    
    function showLoginForm() {
        document.getElementById('login-form').style.display = 'block';
        document.getElementById('register-form').style.display = 'none';
    }

    function showRegisterForm() {
        document.getElementById('login-form').style.display = 'none';
        document.getElementById('register-form').style.display = 'block';
    }

    function showTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        document.getElementById(tabId).classList.add('active');
        
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('active');
        });
        document.getElementById(tabId + '-button').classList.add('active');

        // Render data khi chuy·ªÉn tab
        if (tabId === 'tab-test') renderTests();
        if (tabId === 'tab-students') renderStudents();
        if (tabId === 'tab-results') renderResults();
    }
    
    // --- AUTHENTICATION ---
    
    async function login() {
        const user = document.getElementById('login-username').value;
        const pass = document.getElementById('login-password').value;
        const messageElement = document.getElementById('login-message');
        
        try {
            const response = await fetch(`${serverUrl}/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user, pass })
            });

            const data = await response.json();

            if (data.success) {
                currentUserId = data.user.id;
                currentUserRole = data.user.role;
                document.getElementById('auth-container').style.display = 'none';
                document.getElementById('app-content').style.display = 'block';
                document.getElementById('user-display').textContent = `Ch√†o m·ª´ng, ${data.user.user} (${data.user.role})`;
                showTab('tab-test'); // M·ªü tab m·∫∑c ƒë·ªãnh
            } else {
                messageElement.textContent = data.message;
            }
        } catch (error) {
            messageElement.textContent = 'L·ªói k·∫øt n·ªëi ƒë·∫øn server.';
        }
    }
    
    async function register() {
        const user = document.getElementById('register-username').value;
        const pass = document.getElementById('register-password').value;
        const dob = document.getElementById('register-dob').value;
        const gender = document.getElementById('register-gender').value;
        const messageElement = document.getElementById('register-message');

        try {
            const response = await fetch(`${serverUrl}/register`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user, pass, dob, gender })
            });

            const data = await response.json();

            if (data.success) {
                alert('ƒêƒÉng k√Ω th√†nh c√¥ng! Vui l√≤ng ƒëƒÉng nh·∫≠p.');
                showLoginForm();
            } else {
                messageElement.textContent = data.message;
            }
        } catch (error) {
            messageElement.textContent = 'L·ªói k·∫øt n·ªëi ƒë·∫øn server.';
        }
    }

    function logout() {
        currentUserId = null;
        currentUserRole = null;
        document.getElementById('auth-container').style.display = 'block';
        document.getElementById('app-content').style.display = 'none';
        document.getElementById('login-username').value = '';
        document.getElementById('login-password').value = '';
        document.getElementById('login-message').textContent = '';
    }

    // --- TEST MANAGEMENT ---
    
    async function addTest() {
        const name = document.getElementById('test-name').value;
        const subject = document.getElementById('test-subject').value;
        const level = document.getElementById('test-level').value;
        const time = document.getElementById('test-time').value;

        if (!name || !subject || !level || !time) {
            alert("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin.");
            return;
        }

        const newTest = {
            name,
            time: parseInt(time),
            subject,
            level,
            questions: [], 
            teacherId: currentUserId
        };

        try {
            const response = await fetch(`${serverUrl}/tests`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(newTest)
            });

            if (response.ok) {
                alert("T·∫°o b√†i ki·ªÉm tra th√†nh c√¥ng!");
                document.getElementById('create-test-modal').style.display = 'none';
                renderTests();
            } else {
                alert("L·ªói khi t·∫°o b√†i ki·ªÉm tra.");
            }
        } catch (error) {
            alert("L·ªói k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß.");
        }
    }

    async function renderTests() {
        const testListDiv = document.getElementById('tests-list');
        
        if (!document.getElementById('test-table')) {
            const tableHTML = `
                <table id="test-table" border="1" style="width:100%; border-collapse: collapse; margin-top: 10px;">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>T√™n b√†i ki·ªÉm tra</th>
                            <th>M√¥n h·ªçc</th>
                            <th>Kh·ªëi</th>
                            <th>S·ªë c√¢u</th>
                            <th>Th·ªùi gian (ph√∫t)</th>
                            <th>Ng√†y t·∫°o</th>
                            <th>Ng√†y giao</th>
                            <th>Tr·∫°ng th√°i</th> 
                            <th>H√†nh ƒë·ªông</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            `;
            testListDiv.innerHTML = tableHTML;
        }
        
        const tbody = document.querySelector('#test-table tbody');
        tbody.innerHTML = ''; 

        try {
            const response = await fetch(`${serverUrl}/tests`);
            const tests = await response.json();
            
            if (tests.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 10px;">Ch∆∞a c√≥ b√†i ki·ªÉm tra n√†o ƒë∆∞·ª£c t·∫°o.</td></tr>';
                return;
            }
            
            tests.forEach((test, i) => {
                const tr = document.createElement('tr');
                
                const questionCount = test.questions ? test.questions.length : 0;
                const subjectName = SUBJECT_NAMES[test.subject] || test.subject || '-';
                
                const createdAt = formatDate(test.createdAt || new Date().toISOString()); 
                
                // Gi·∫£ ƒë·ªãnh: L·∫•y ng√†y giao g·∫ßn nh·∫•t t·ª´ tr∆∞·ªùng assignedDate n·∫øu c√≥. 
                // N·∫øu b·∫°n c√≥ m·ªôt m·∫£ng giao ƒë·ªÅ (assigns) ri√™ng, logic s·∫Ω ph·ª©c t·∫°p h∆°n.
                const assignedDateDisplay = formatDate(test.assignedDate); 
                
                const isAssigned = test.assignedDate;

                let statusText;
                let statusColor;

                if (isAssigned) {
                    statusText = 'ƒê√£ giao';
                    statusColor = 'green';
                } else {
                    statusText = 'Ch∆∞a giao';
                    statusColor = 'orange';
                }

                tr.innerHTML = `
                    <td>${i + 1}</td>
                    <td>${escapeHtml(test.name) || 'Kh√¥ng t√™n'}</td>
                    <td>${subjectName}</td>
                    <td>${test.level || '-'}</td>
                    <td>${questionCount}</td>
                    <td>${test.time || '-'}</td>
                    <td>${createdAt}</td>
                    <td>${assignedDateDisplay}</td>
                    <td style="color: ${statusColor}; font-weight: bold;">${statusText}</td>
                    <td>
                        <button onclick="openAssignModal('${test.id}', '${escapeHtml(test.name)}')" class="btn-primary" style="margin-right: 5px;">Giao ƒë·ªÅ</button> 
                        <button onclick="viewTestContent('${test.id}')" class="btn-info">Xem</button>
                        <button onclick="editTest('${test.id}')" class="btn-edit">S·ª≠a</button>
                        <button onclick="deleteTest('${test.id}')" class="btn-delete">X√≥a</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        } catch (error) {
            console.error('L·ªói khi t·∫£i danh s√°ch b√†i ki·ªÉm tra:', error);
            tbody.innerHTML = '<tr><td colspan="10" style="color: red; text-align: center; padding: 10px;">L·ªói k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß.</td></tr>';
        }
    }
    
    async function viewTestContent(testId) {
        try {
            const response = await fetch(`${serverUrl}/tests/${testId}`);
            const test = await response.json();
            
            document.getElementById('view-test-name').textContent = escapeHtml(test.name);
            document.getElementById('view-test-time').textContent = test.time;
            
            const questionsDiv = document.getElementById('view-test-questions');
            questionsDiv.innerHTML = '';

            if (test.questions && test.questions.length > 0) {
                test.questions.forEach((q, index) => {
                    const qDiv = document.createElement('div');
                    qDiv.innerHTML = `
                        <hr>
                        <h4>C√¢u ${index + 1}: ${escapeHtml(q.q || 'C√¢u h·ªèi ch∆∞a c√≥ n·ªôi dung')}</h4>
                        <p>ƒê√°p √°n: ${escapeHtml(q.options.find(opt => opt.isCorrect).text || 'Ch∆∞a c√≥ ƒë√°p √°n ƒë√∫ng')}</p>
                    `;
                    questionsDiv.appendChild(qDiv);
                });
            } else {
                questionsDiv.innerHTML = '<p>B√†i ki·ªÉm tra n√†y ch∆∞a c√≥ c√¢u h·ªèi n√†o.</p>';
            }

            document.getElementById('view-test-content-modal').style.display = 'block';
        } catch (error) {
            console.error('L·ªói khi t·∫£i n·ªôi dung b√†i ki·ªÉm tra:', error);
            alert('Kh√¥ng th·ªÉ t·∫£i n·ªôi dung b√†i ki·ªÉm tra.');
        }
    }

    // --- TEST ACTION FUNCTIONS (S·ª¨A/X√ìA) ---
    let currentEditingTest = null; 

    async function editTest(testId) {
        try {
            const response = await fetch(`${serverUrl}/tests/${testId}`);
            const test = await response.json();
            
            currentEditingTest = test;

            document.getElementById('edit-test-id').value = test.id;
            document.getElementById('edit-test-name').value = test.name;
            document.getElementById('edit-test-time').value = test.time || '';
            document.getElementById('edit-test-subject').value = test.subject || '';
            document.getElementById('edit-test-level').value = test.level || '';
            
            document.getElementById('edit-test-modal').style.display = 'block';

        } catch (error) {
            console.error('L·ªói khi t·∫£i d·ªØ li·ªáu b√†i ki·ªÉm tra:', error);
            alert('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu ƒë·ªÉ ch·ªânh s·ª≠a.');
        }
    }

    async function updateTest() {
        const testId = document.getElementById('edit-test-id').value;
        
        const updatedData = {
            name: document.getElementById('edit-test-name').value,
            time: parseInt(document.getElementById('edit-test-time').value),
            subject: document.getElementById('edit-test-subject').value,
            level: document.getElementById('edit-test-level').value,
        };

        try {
            const response = await fetch(`${serverUrl}/tests/${testId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updatedData)
            });

            if (response.ok) {
                alert("C·∫≠p nh·∫≠t b√†i ki·ªÉm tra th√†nh c√¥ng!");
                document.getElementById('edit-test-modal').style.display = 'none';
                renderTests();
            } else {
                alert("L·ªói khi c·∫≠p nh·∫≠t b√†i ki·ªÉm tra.");
            }
        } catch (error) {
            console.error('L·ªói c·∫≠p nh·∫≠t:', error);
            alert("L·ªói k·∫øt n·ªëi ho·∫∑c c·∫≠p nh·∫≠t d·ªØ li·ªáu.");
        }
    }

    async function deleteTest(testId) {
        if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√†i ki·ªÉm tra n√†y kh√¥ng? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.")) {
            try {
                const response = await fetch(`${serverUrl}/tests/${testId}`, {
                    method: 'DELETE'
                });

                if (response.status === 204 || response.ok) {
                    alert("X√≥a b√†i ki·ªÉm tra th√†nh c√¥ng!");
                    renderTests(); 
                } else {
                    const errorText = await response.text();
                    try {
                        const errorData = JSON.parse(errorText);
                        alert(`L·ªói khi x√≥a: ${errorData.message || 'Kh√¥ng th·ªÉ x√≥a b√†i ki·ªÉm tra.'}`);
                    } catch {
                        alert(`L·ªói khi x√≥a: Server tr·∫£ v·ªÅ l·ªói ${response.status}.`);
                    }
                }
            } catch (error) {
                console.error('L·ªói k·∫øt n·ªëi:', error);
                alert("L·ªói k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß. Vui l√≤ng th·ª≠ l·∫°i.");
            }
        }
    }
    
    // --- TEST ASSIGNMENT FUNCTIONS (GIAO ƒê·ªÄ) ---
    
    async function loadStudentsForAssignment() {
        const select = document.getElementById('assign-modal-student');
        select.innerHTML = '<option value="">-- Ch·ªçn h·ªçc sinh --</option>'; 
        
        try {
            const response = await fetch(`${serverUrl}/users`); 
            const users = await response.json();
            
            const students = users.filter(u => u.role === 'student');
            
            students.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = `${student.user} (ID: ${student.id.substring(0, 4)}...)`;
                select.appendChild(option);
            });
        } catch (error) {
            console.error("L·ªói khi t·∫£i danh s√°ch h·ªçc sinh:", error);
        }
    }

    function openAssignModal(testId, testName) {
        document.getElementById('assign-modal-test-id').value = testId;
        document.getElementById('assign-modal-test-name').textContent = testName;
        
        loadStudentsForAssignment();
        
        document.getElementById('assign-modal-deadline').value = ''; 
        document.getElementById('assign-test-modal').style.display = 'block';
    }

    async function submitTestAssignment() {
        const testId = document.getElementById('assign-modal-test-id').value;
        const studentId = document.getElementById('assign-modal-student').value;
        const deadline = document.getElementById('assign-modal-deadline').value;
        
        if (!studentId || !deadline) {
            alert("Vui l√≤ng ch·ªçn h·ªçc sinh v√† ƒë·∫∑t h·∫°n ch√≥t.");
            return;
        }

        const newAssignment = {
            testId,
            studentId,
            deadline: new Date(deadline).toISOString(), 
            status: 'assigned' 
        };
        
        try {
            const response = await fetch(`${serverUrl}/assigns`, { 
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(newAssignment),
            });

            if (response.ok) {
                alert("Giao ƒë·ªÅ th√†nh c√¥ng!");
                document.getElementById('assign-test-modal').style.display = 'none';
                renderTests();
            } else {
                alert("L·ªói khi giao ƒë·ªÅ.");
            }
        } catch (error) {
            alert("L·ªói k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß.");
        }
    }
    
    // --- STUDENT MANAGEMENT ---
    
    async function renderStudents() {
        const studentsListDiv = document.getElementById('students-list');
        let tableHTML = `
            <h2>Danh s√°ch H·ªçc sinh</h2>
            <table border="1" style="width:100%; border-collapse: collapse; margin-top: 10px;">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>ID</th>
                        <th>T√™n ƒëƒÉng nh·∫≠p</th>
                        <th>Vai tr√≤</th>
                        <th>Ng√†y sinh</th>
                        <th>Gi·ªõi t√≠nh</th>
                        <th>H√†nh ƒë·ªông</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        try {
            const response = await fetch(`${serverUrl}/users`);
            const users = await response.json();
            const students = users.filter(u => u.role === 'student');

            if (students.length === 0) {
                tableHTML += '<tr><td colspan="7" style="text-align: center; padding: 10px;">Ch∆∞a c√≥ h·ªçc sinh n√†o.</td></tr>';
            } else {
                students.forEach((student, i) => {
                    tableHTML += `
                        <tr>
                            <td>${i + 1}</td>
                            <td>${student.id.substring(0, 8)}...</td>
                            <td>${escapeHtml(student.user)}</td>
                            <td>${student.role}</td>
                            <td>${student.dob || '-'}</td>
                            <td>${student.gender || '-'}</td>
                            <td><button onclick="deleteUser('${student.id}')" class="btn-delete">X√≥a</button></td>
                        </tr>
                    `;
                });
            }
            
            tableHTML += '</tbody></table>';
            studentsListDiv.innerHTML = tableHTML;

        } catch (error) {
            console.error('L·ªói khi t·∫£i danh s√°ch h·ªçc sinh:', error);
            studentsListDiv.innerHTML = '<p style="color: red;">L·ªói k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß khi t·∫£i danh s√°ch h·ªçc sinh.</p>';
        }
    }
    
    async function deleteUser(userId) {
        if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ng∆∞·ªùi d√πng n√†y kh√¥ng?")) {
            try {
                const response = await fetch(`${serverUrl}/users/${userId}`, {
                    method: 'DELETE'
                });

                if (response.status === 204 || response.ok) {
                    alert("X√≥a ng∆∞·ªùi d√πng th√†nh c√¥ng!");
                    renderStudents(); 
                } else {
                    alert("L·ªói khi x√≥a ng∆∞·ªùi d√πng.");
                }
            } catch (error) {
                alert("L·ªói k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß.");
            }
        }
    }
    
    // --- RESULT MANAGEMENT ---

    async function renderResults() {
        const resultsListDiv = document.getElementById('results-list');
        let tableHTML = `
            <table border="1" style="width:100%; border-collapse: collapse; margin-top: 10px;">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>B√†i ki·ªÉm tra</th>
                        <th>H·ªçc sinh</th>
                        <th>ƒêi·ªÉm</th>
                        <th>Th·ªùi gian n·ªôp</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        try {
            const resultsResponse = await fetch(`${serverUrl}/results`);
            const results = await resultsResponse.json();
            
            // T·∫£i danh s√°ch users v√† tests ƒë·ªÉ √°nh x·∫° ID th√†nh t√™n
            const usersResponse = await fetch(`${serverUrl}/users`);
            const users = await usersResponse.json();
            const testsResponse = await fetch(`${serverUrl}/tests`);
            const tests = await testsResponse.json();

            const userMap = users.reduce((map, user) => { map[user.id] = user.user; return map; }, {});
            const testMap = tests.reduce((map, test) => { map[test.id] = test.name; return map; }, {});

            if (results.length === 0) {
                tableHTML += '<tr><td colspan="5" style="text-align: center; padding: 10px;">Ch∆∞a c√≥ k·∫øt qu·∫£ b√†i l√†m n√†o.</td></tr>';
            } else {
                results.forEach((result, i) => {
                    const studentName = userMap[result.studentId] || 'Kh√¥ng x√°c ƒë·ªãnh';
                    const testName = testMap[result.testId] || 'Kh√¥ng x√°c ƒë·ªãnh';
                    
                    tableHTML += `
                        <tr>
                            <td>${i + 1}</td>
                            <td>${escapeHtml(testName)}</td>
                            <td>${escapeHtml(studentName)}</td>
                            <td>${result.score || 'N/A'}</td>
                            <td>${formatDate(result.submittedAt)}</td>
                        </tr>
                    `;
                });
            }
            
            tableHTML += '</tbody></table>';
            resultsListDiv.innerHTML = tableHTML;

        } catch (error) {
            console.error('L·ªói khi t·∫£i k·∫øt qu·∫£:', error);
            resultsListDiv.innerHTML = '<p style="color: red;">L·ªói k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß khi t·∫£i k·∫øt qu·∫£ b√†i l√†m.</p>';
        }
    }
    
    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        showLoginForm(); 
    });

</script>

</body>
</html>
