<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ thống Quản lý Bài kiểm tra</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f4f4; }
        #app-container { max-width: 1200px; margin: 20px auto; background-color: #fff; padding: 20px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); }
        h1 { text-align: center; color: #333; }
        #nav-bar { display: flex; justify-content: space-around; background-color: #007bff; padding: 10px 0; margin-bottom: 20px; }
        .tab-button { background: none; border: none; color: white; padding: 10px 20px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; }
        .tab-button:hover, .tab-button.active { background-color: #0056b3; }
        .tab-content { display: none; padding: 20px; border: 1px solid #ccc; border-top: none; }
        .tab-content.active { display: block; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .btn { background-color: #28a745; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px; }
        .btn:hover { background-color: #1e7e34; }
        .btn-primary { background-color: #007bff; }
        .btn-primary:hover { background-color: #0056b3; }
        .btn-info { background-color: #17a2b8; }
        .btn-info:hover { background-color: #0f6674; }
        .btn-edit { background-color: #ffc107; color: #333; }
        .btn-edit:hover { background-color: #e0a800; }
        .btn-delete { background-color: #dc3545; }
        .btn-delete:hover { background-color: #bd2130; }
        .logout { background-color: #6c757d; }
        .logout:hover { background-color: #5a6268; }
        
        /* Table Styles */
        #test-table th, #test-table td { padding: 8px; text-align: left; border: 1px solid #ddd; }
        #test-table th { background-color: #f2f2f2; }
        
        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 8px; position: relative;}
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close:hover, .close:focus { color: black; text-decoration: none; cursor: pointer; }

        /* Login/Register Form */
        #login-form, #register-form { max-width: 400px; margin: 50px auto; padding: 20px; border: 1px solid #ccc; border-radius: 8px; background-color: #fff; }

    </style>
</head>
<body>

<div id="auth-container">
    <div id="login-form">
        <h2>Đăng nhập</h2>
        <div class="form-group">
            <label for="login-username">Tên đăng nhập:</label>
            <input type="text" id="login-username" required>
        </div>
        <div class="form-group">
            <label for="login-password">Mật khẩu:</label>
            <input type="password" id="login-password" required>
        </div>
        <button class="btn btn-primary" onclick="login()">Đăng nhập</button>
        <button class="btn logout" onclick="showRegisterForm()">Đăng ký</button>
        <p id="login-message" style="color: red; margin-top: 10px;"></p>
    </div>

    <div id="register-form" style="display: none;">
        <h2>Đăng ký</h2>
        <div class="form-group">
            <label for="register-username">Tên đăng nhập:</label>
            <input type="text" id="register-username" required>
        </div>
        <div class="form-group">
            <label for="register-password">Mật khẩu:</label>
            <input type="password" id="register-password" required>
        </div>
        <div class="form-group">
            <label for="register-dob">Ngày sinh:</label>
            <input type="date" id="register-dob">
        </div>
        <div class="form-group">
            <label for="register-gender">Giới tính:</label>
            <select id="register-gender">
                <option value="Nam">Nam</option>
                <option value="Nữ">Nữ</option>
                <option value="Khác">Khác</option>
            </select>
        </div>
        <button class="btn btn-primary" onclick="register()">Đăng ký</button>
        <button class="btn logout" onclick="showLoginForm()">Hủy</button>
        <p id="register-message" style="color: red; margin-top: 10px;"></p>
    </div>
</div>

<div id="app-content" style="display: none;">
    <h1 id="user-display"></h1>
    <div id="nav-bar">
        <button class="tab-button active" id="tab-test-button" onclick="showTab('tab-test')">Bài kiểm tra</button>
        <button class="tab-button" id="tab-students-button" onclick="showTab('tab-students')">Học sinh</button>
        <button class="tab-button" id="tab-results-button" onclick="showTab('tab-results')">Kết quả bài làm</button>
        <button class="btn logout" onclick="logout()">Đăng xuất</button>
    </div>

    <div id="tab-test" class="tab-content active">
        <h2>Quản lý Bài kiểm tra</h2>
        <button class="btn" onclick="document.getElementById('create-test-modal').style.display='block'">+ Tạo Bài kiểm tra mới</button>
        
        <div id="tests-list">
            <table id="test-table" border="1" style="width:100%; border-collapse: collapse; margin-top: 10px;">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>Tên bài kiểm tra</th>
                        <th>Môn học</th>
                        <th>Khối</th>
                        <th>Số câu</th>
                        <th>Thời gian (phút)</th>
                        <th>Ngày tạo</th>
                        <th>Ngày giao</th>
                        <th>Trạng thái</th>
                        <th>Hành động</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
    </div>
    
    <div id="create-test-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="document.getElementById('create-test-modal').style.display='none'">&times;</span>
            <h3>Tạo Bài kiểm tra mới</h3>
            <div class="form-group">
                <label for="test-name">Tên bài kiểm tra:</label>
                <input type="text" id="test-name" required>
            </div>
            <div class="form-group">
                <label for="test-subject">Môn học:</label>
                <select id="test-subject">
                    <option value="toan">Toán</option>
                    <option value="ly">Lý</option>
                    <option value="hoa">Hóa</option>
                    <option value="anh">Anh</option>
                </select>
            </div>
            <div class="form-group">
                <label for="test-level">Khối:</label>
                <input type="text" id="test-level">
            </div>
            <div class="form-group">
                <label for="test-time">Thời gian (phút):</label>
                <input type="number" id="test-time">
            </div>
            <button class="btn" onclick="addTest()">Tạo</button>
            <button class="btn logout" onclick="document.getElementById('create-test-modal').style.display='none'">Hủy</button>
        </div>
    </div>

    <div id="view-test-content-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="document.getElementById('view-test-content-modal').style.display='none'">&times;</span>
            <h3>Nội dung Bài kiểm tra: <span id="view-test-name"></span></h3>
            <p>Thời gian: <span id="view-test-time"></span> phút</p>
            <div id="view-test-questions">
                </div>
        </div>
    </div>
    
    <div id="edit-test-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="document.getElementById('edit-test-modal').style.display='none'">&times;</span>
            <h3>Chỉnh sửa Bài kiểm tra</h3>
            <input type="hidden" id="edit-test-id">
            <div class="form-group">
                <label for="edit-test-name">Tên bài kiểm tra:</label>
                <input type="text" id="edit-test-name" required>
            </div>
            <div class="form-group">
                <label for="edit-test-subject">Môn học:</label>
                <select id="edit-test-subject">
                    <option value="toan">Toán</option>
                    <option value="ly">Lý</option>
                    <option value="hoa">Hóa</option>
                    <option value="anh">Anh</option>
                </select>
            </div>
            <div class="form-group">
                <label for="edit-test-level">Khối:</label>
                <input type="text" id="edit-test-level">
            </div>
            <div class="form-group">
                <label for="edit-test-time">Thời gian (phút):</label>
                <input type="number" id="edit-test-time">
            </div>
            <button class="btn" onclick="updateTest()">Lưu</button>
            <button class="btn logout" onclick="document.getElementById('edit-test-modal').style.display='none'">Hủy</button>
        </div>
    </div>
    
    <div id="assign-test-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="document.getElementById('assign-test-modal').style.display='none'">&times;</span>
            <h3>Giao đề kiểm tra</h3>
            <input type="hidden" id="assign-modal-test-id">
            
            <p>Bài kiểm tra đang giao: <strong id="assign-modal-test-name"></strong></p>

            <div class="form-group">
                <label for="assign-modal-student">Chọn học sinh:</label>
                <select id="assign-modal-student">
                    <option value="">-- Chọn học sinh --</option>
                </select>
            </div>

            <div class="form-group">
                <label for="assign-modal-deadline">Hạn chót:</label>
                <input type="datetime-local" id="assign-modal-deadline" />
            </div>

            <button class="btn btn-primary" onclick="submitTestAssignment()">Giao đề</button>
            <button class="btn logout" onclick="document.getElementById('assign-test-modal').style.display='none'">Hủy</button>
        </div>
    </div>


    </div> <div id="tab-students" class="tab-content">
        <h2>Quản lý Học sinh</h2>
        <div id="students-list">
             </div>
    </div>

    <div id="tab-results" class="tab-content">
        <h2>Kết quả Bài làm</h2>
        <div id="results-list">
             </div>
    </div>
</div>


<script>
    // 💡 ĐẢM BẢO CHUỖI KẾT NỐI MONGODB CỦA BẠN LÀ CHÍNH XÁC
    // Thay thế bằng URL thực tế nếu bạn đã triển khai server (ví dụ: http://localhost:3000/api)
   const serverUrl = window.location.origin;
    let currentUserId = null;
    let currentUserRole = null;
    
    const SUBJECT_NAMES = {
        'toan': 'Toán',
        'ly': 'Lý',
        'hoa': 'Hóa',
        'anh': 'Anh'
    };

    // --- HELPER FUNCTIONS ---

    function escapeHtml(unsafe) {
        if (!unsafe) return '';
        return unsafe.toString()
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    function formatDate(isoString) {
        if (!isoString) return 'Chưa có';
        try {
            const date = new Date(isoString);
            if (isNaN(date.getTime())) return 'Ngày không hợp lệ';
            return date.toLocaleDateString('vi-VN') + ' ' + date.toLocaleTimeString('vi-VN');
        } catch (e) {
            return 'Ngày không hợp lệ';
        }
    }
    
    // --- NAVIGATION ---
    
    function showLoginForm() {
        document.getElementById('login-form').style.display = 'block';
        document.getElementById('register-form').style.display = 'none';
    }

    function showRegisterForm() {
        document.getElementById('login-form').style.display = 'none';
        document.getElementById('register-form').style.display = 'block';
    }

    function showTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        document.getElementById(tabId).classList.add('active');
        
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('active');
        });
        document.getElementById(tabId + '-button').classList.add('active');

        // Render data khi chuyển tab
        if (tabId === 'tab-test') renderTests();
        if (tabId === 'tab-students') renderStudents();
        if (tabId === 'tab-results') renderResults();
    }
    
    // --- AUTHENTICATION ---
    
    async function login() {
        const user = document.getElementById('login-username').value;
        const pass = document.getElementById('login-password').value;
        const messageElement = document.getElementById('login-message');
        
        try {
            const response = await fetch(`${serverUrl}/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user, pass })
            });

            const data = await response.json();

            if (data.success) {
                currentUserId = data.user.id;
                currentUserRole = data.user.role;
                document.getElementById('auth-container').style.display = 'none';
                document.getElementById('app-content').style.display = 'block';
                document.getElementById('user-display').textContent = `Chào mừng, ${data.user.user} (${data.user.role})`;
                showTab('tab-test'); // Mở tab mặc định
            } else {
                messageElement.textContent = data.message;
            }
        } catch (error) {
            messageElement.textContent = 'Lỗi kết nối đến server.';
        }
    }
    
    async function register() {
        const user = document.getElementById('register-username').value;
        const pass = document.getElementById('register-password').value;
        const dob = document.getElementById('register-dob').value;
        const gender = document.getElementById('register-gender').value;
        const messageElement = document.getElementById('register-message');

        try {
            const response = await fetch(`${serverUrl}/register`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user, pass, dob, gender })
            });

            const data = await response.json();

            if (data.success) {
                alert('Đăng ký thành công! Vui lòng đăng nhập.');
                showLoginForm();
            } else {
                messageElement.textContent = data.message;
            }
        } catch (error) {
            messageElement.textContent = 'Lỗi kết nối đến server.';
        }
    }

    function logout() {
        currentUserId = null;
        currentUserRole = null;
        document.getElementById('auth-container').style.display = 'block';
        document.getElementById('app-content').style.display = 'none';
        document.getElementById('login-username').value = '';
        document.getElementById('login-password').value = '';
        document.getElementById('login-message').textContent = '';
    }

    // --- TEST MANAGEMENT ---
    
    async function addTest() {
        const name = document.getElementById('test-name').value;
        const subject = document.getElementById('test-subject').value;
        const level = document.getElementById('test-level').value;
        const time = document.getElementById('test-time').value;

        if (!name || !subject || !level || !time) {
            alert("Vui lòng điền đầy đủ thông tin.");
            return;
        }

        const newTest = {
            name,
            time: parseInt(time),
            subject,
            level,
            questions: [], 
            teacherId: currentUserId
        };

        try {
            const response = await fetch(`${serverUrl}/tests`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(newTest)
            });

            if (response.ok) {
                alert("Tạo bài kiểm tra thành công!");
                document.getElementById('create-test-modal').style.display = 'none';
                renderTests();
            } else {
                alert("Lỗi khi tạo bài kiểm tra.");
            }
        } catch (error) {
            alert("Lỗi kết nối đến máy chủ.");
        }
    }

    async function renderTests() {
        const testListDiv = document.getElementById('tests-list');
        
        if (!document.getElementById('test-table')) {
            const tableHTML = `
                <table id="test-table" border="1" style="width:100%; border-collapse: collapse; margin-top: 10px;">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Tên bài kiểm tra</th>
                            <th>Môn học</th>
                            <th>Khối</th>
                            <th>Số câu</th>
                            <th>Thời gian (phút)</th>
                            <th>Ngày tạo</th>
                            <th>Ngày giao</th>
                            <th>Trạng thái</th> 
                            <th>Hành động</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            `;
            testListDiv.innerHTML = tableHTML;
        }
        
        const tbody = document.querySelector('#test-table tbody');
        tbody.innerHTML = ''; 

        try {
            const response = await fetch(`${serverUrl}/tests`);
            const tests = await response.json();
            
            if (tests.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 10px;">Chưa có bài kiểm tra nào được tạo.</td></tr>';
                return;
            }
            
            tests.forEach((test, i) => {
                const tr = document.createElement('tr');
                
                const questionCount = test.questions ? test.questions.length : 0;
                const subjectName = SUBJECT_NAMES[test.subject] || test.subject || '-';
                
                const createdAt = formatDate(test.createdAt || new Date().toISOString()); 
                
                // Giả định: Lấy ngày giao gần nhất từ trường assignedDate nếu có. 
                // Nếu bạn có một mảng giao đề (assigns) riêng, logic sẽ phức tạp hơn.
                const assignedDateDisplay = formatDate(test.assignedDate); 
                
                const isAssigned = test.assignedDate;

                let statusText;
                let statusColor;

                if (isAssigned) {
                    statusText = 'Đã giao';
                    statusColor = 'green';
                } else {
                    statusText = 'Chưa giao';
                    statusColor = 'orange';
                }

                tr.innerHTML = `
                    <td>${i + 1}</td>
                    <td>${escapeHtml(test.name) || 'Không tên'}</td>
                    <td>${subjectName}</td>
                    <td>${test.level || '-'}</td>
                    <td>${questionCount}</td>
                    <td>${test.time || '-'}</td>
                    <td>${createdAt}</td>
                    <td>${assignedDateDisplay}</td>
                    <td style="color: ${statusColor}; font-weight: bold;">${statusText}</td>
                    <td>
                        <button onclick="openAssignModal('${test.id}', '${escapeHtml(test.name)}')" class="btn-primary" style="margin-right: 5px;">Giao đề</button> 
                        <button onclick="viewTestContent('${test.id}')" class="btn-info">Xem</button>
                        <button onclick="editTest('${test.id}')" class="btn-edit">Sửa</button>
                        <button onclick="deleteTest('${test.id}')" class="btn-delete">Xóa</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        } catch (error) {
            console.error('Lỗi khi tải danh sách bài kiểm tra:', error);
            tbody.innerHTML = '<tr><td colspan="10" style="color: red; text-align: center; padding: 10px;">Lỗi kết nối đến máy chủ.</td></tr>';
        }
    }
    
    async function viewTestContent(testId) {
        try {
            const response = await fetch(`${serverUrl}/tests/${testId}`);
            const test = await response.json();
            
            document.getElementById('view-test-name').textContent = escapeHtml(test.name);
            document.getElementById('view-test-time').textContent = test.time;
            
            const questionsDiv = document.getElementById('view-test-questions');
            questionsDiv.innerHTML = '';

            if (test.questions && test.questions.length > 0) {
                test.questions.forEach((q, index) => {
                    const qDiv = document.createElement('div');
                    qDiv.innerHTML = `
                        <hr>
                        <h4>Câu ${index + 1}: ${escapeHtml(q.q || 'Câu hỏi chưa có nội dung')}</h4>
                        <p>Đáp án: ${escapeHtml(q.options.find(opt => opt.isCorrect).text || 'Chưa có đáp án đúng')}</p>
                    `;
                    questionsDiv.appendChild(qDiv);
                });
            } else {
                questionsDiv.innerHTML = '<p>Bài kiểm tra này chưa có câu hỏi nào.</p>';
            }

            document.getElementById('view-test-content-modal').style.display = 'block';
        } catch (error) {
            console.error('Lỗi khi tải nội dung bài kiểm tra:', error);
            alert('Không thể tải nội dung bài kiểm tra.');
        }
    }

    // --- TEST ACTION FUNCTIONS (SỬA/XÓA) ---
    let currentEditingTest = null; 

    async function editTest(testId) {
        try {
            const response = await fetch(`${serverUrl}/tests/${testId}`);
            const test = await response.json();
            
            currentEditingTest = test;

            document.getElementById('edit-test-id').value = test.id;
            document.getElementById('edit-test-name').value = test.name;
            document.getElementById('edit-test-time').value = test.time || '';
            document.getElementById('edit-test-subject').value = test.subject || '';
            document.getElementById('edit-test-level').value = test.level || '';
            
            document.getElementById('edit-test-modal').style.display = 'block';

        } catch (error) {
            console.error('Lỗi khi tải dữ liệu bài kiểm tra:', error);
            alert('Không thể tải dữ liệu để chỉnh sửa.');
        }
    }

    async function updateTest() {
        const testId = document.getElementById('edit-test-id').value;
        
        const updatedData = {
            name: document.getElementById('edit-test-name').value,
            time: parseInt(document.getElementById('edit-test-time').value),
            subject: document.getElementById('edit-test-subject').value,
            level: document.getElementById('edit-test-level').value,
        };

        try {
            const response = await fetch(`${serverUrl}/tests/${testId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updatedData)
            });

            if (response.ok) {
                alert("Cập nhật bài kiểm tra thành công!");
                document.getElementById('edit-test-modal').style.display = 'none';
                renderTests();
            } else {
                alert("Lỗi khi cập nhật bài kiểm tra.");
            }
        } catch (error) {
            console.error('Lỗi cập nhật:', error);
            alert("Lỗi kết nối hoặc cập nhật dữ liệu.");
        }
    }

    async function deleteTest(testId) {
        if (confirm("Bạn có chắc chắn muốn xóa bài kiểm tra này không? Hành động này không thể hoàn tác.")) {
            try {
                const response = await fetch(`${serverUrl}/tests/${testId}`, {
                    method: 'DELETE'
                });

                if (response.status === 204 || response.ok) {
                    alert("Xóa bài kiểm tra thành công!");
                    renderTests(); 
                } else {
                    const errorText = await response.text();
                    try {
                        const errorData = JSON.parse(errorText);
                        alert(`Lỗi khi xóa: ${errorData.message || 'Không thể xóa bài kiểm tra.'}`);
                    } catch {
                        alert(`Lỗi khi xóa: Server trả về lỗi ${response.status}.`);
                    }
                }
            } catch (error) {
                console.error('Lỗi kết nối:', error);
                alert("Lỗi kết nối đến máy chủ. Vui lòng thử lại.");
            }
        }
    }
    
    // --- TEST ASSIGNMENT FUNCTIONS (GIAO ĐỀ) ---
    
    async function loadStudentsForAssignment() {
        const select = document.getElementById('assign-modal-student');
        select.innerHTML = '<option value="">-- Chọn học sinh --</option>'; 
        
        try {
            const response = await fetch(`${serverUrl}/users`); 
            const users = await response.json();
            
            const students = users.filter(u => u.role === 'student');
            
            students.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = `${student.user} (ID: ${student.id.substring(0, 4)}...)`;
                select.appendChild(option);
            });
        } catch (error) {
            console.error("Lỗi khi tải danh sách học sinh:", error);
        }
    }

    function openAssignModal(testId, testName) {
        document.getElementById('assign-modal-test-id').value = testId;
        document.getElementById('assign-modal-test-name').textContent = testName;
        
        loadStudentsForAssignment();
        
        document.getElementById('assign-modal-deadline').value = ''; 
        document.getElementById('assign-test-modal').style.display = 'block';
    }

    async function submitTestAssignment() {
        const testId = document.getElementById('assign-modal-test-id').value;
        const studentId = document.getElementById('assign-modal-student').value;
        const deadline = document.getElementById('assign-modal-deadline').value;
        
        if (!studentId || !deadline) {
            alert("Vui lòng chọn học sinh và đặt hạn chót.");
            return;
        }

        const newAssignment = {
            testId,
            studentId,
            deadline: new Date(deadline).toISOString(), 
            status: 'assigned' 
        };
        
        try {
            const response = await fetch(`${serverUrl}/assigns`, { 
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(newAssignment),
            });

            if (response.ok) {
                alert("Giao đề thành công!");
                document.getElementById('assign-test-modal').style.display = 'none';
                renderTests();
            } else {
                alert("Lỗi khi giao đề.");
            }
        } catch (error) {
            alert("Lỗi kết nối đến máy chủ.");
        }
    }
    
    // --- STUDENT MANAGEMENT ---
    
    async function renderStudents() {
        const studentsListDiv = document.getElementById('students-list');
        let tableHTML = `
            <h2>Danh sách Học sinh</h2>
            <table border="1" style="width:100%; border-collapse: collapse; margin-top: 10px;">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>ID</th>
                        <th>Tên đăng nhập</th>
                        <th>Vai trò</th>
                        <th>Ngày sinh</th>
                        <th>Giới tính</th>
                        <th>Hành động</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        try {
            const response = await fetch(`${serverUrl}/users`);
            const users = await response.json();
            const students = users.filter(u => u.role === 'student');

            if (students.length === 0) {
                tableHTML += '<tr><td colspan="7" style="text-align: center; padding: 10px;">Chưa có học sinh nào.</td></tr>';
            } else {
                students.forEach((student, i) => {
                    tableHTML += `
                        <tr>
                            <td>${i + 1}</td>
                            <td>${student.id.substring(0, 8)}...</td>
                            <td>${escapeHtml(student.user)}</td>
                            <td>${student.role}</td>
                            <td>${student.dob || '-'}</td>
                            <td>${student.gender || '-'}</td>
                            <td><button onclick="deleteUser('${student.id}')" class="btn-delete">Xóa</button></td>
                        </tr>
                    `;
                });
            }
            
            tableHTML += '</tbody></table>';
            studentsListDiv.innerHTML = tableHTML;

        } catch (error) {
            console.error('Lỗi khi tải danh sách học sinh:', error);
            studentsListDiv.innerHTML = '<p style="color: red;">Lỗi kết nối đến máy chủ khi tải danh sách học sinh.</p>';
        }
    }
    
    async function deleteUser(userId) {
        if (confirm("Bạn có chắc chắn muốn xóa người dùng này không?")) {
            try {
                const response = await fetch(`${serverUrl}/users/${userId}`, {
                    method: 'DELETE'
                });

                if (response.status === 204 || response.ok) {
                    alert("Xóa người dùng thành công!");
                    renderStudents(); 
                } else {
                    alert("Lỗi khi xóa người dùng.");
                }
            } catch (error) {
                alert("Lỗi kết nối đến máy chủ.");
            }
        }
    }
    
    // --- RESULT MANAGEMENT ---

    async function renderResults() {
        const resultsListDiv = document.getElementById('results-list');
        let tableHTML = `
            <table border="1" style="width:100%; border-collapse: collapse; margin-top: 10px;">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>Bài kiểm tra</th>
                        <th>Học sinh</th>
                        <th>Điểm</th>
                        <th>Thời gian nộp</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        try {
            const resultsResponse = await fetch(`${serverUrl}/results`);
            const results = await resultsResponse.json();
            
            // Tải danh sách users và tests để ánh xạ ID thành tên
            const usersResponse = await fetch(`${serverUrl}/users`);
            const users = await usersResponse.json();
            const testsResponse = await fetch(`${serverUrl}/tests`);
            const tests = await testsResponse.json();

            const userMap = users.reduce((map, user) => { map[user.id] = user.user; return map; }, {});
            const testMap = tests.reduce((map, test) => { map[test.id] = test.name; return map; }, {});

            if (results.length === 0) {
                tableHTML += '<tr><td colspan="5" style="text-align: center; padding: 10px;">Chưa có kết quả bài làm nào.</td></tr>';
            } else {
                results.forEach((result, i) => {
                    const studentName = userMap[result.studentId] || 'Không xác định';
                    const testName = testMap[result.testId] || 'Không xác định';
                    
                    tableHTML += `
                        <tr>
                            <td>${i + 1}</td>
                            <td>${escapeHtml(testName)}</td>
                            <td>${escapeHtml(studentName)}</td>
                            <td>${result.score || 'N/A'}</td>
                            <td>${formatDate(result.submittedAt)}</td>
                        </tr>
                    `;
                });
            }
            
            tableHTML += '</tbody></table>';
            resultsListDiv.innerHTML = tableHTML;

        } catch (error) {
            console.error('Lỗi khi tải kết quả:', error);
            resultsListDiv.innerHTML = '<p style="color: red;">Lỗi kết nối đến máy chủ khi tải kết quả bài làm.</p>';
        }
    }
    
    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        showLoginForm(); 
    });

</script>

</body>
</html>
